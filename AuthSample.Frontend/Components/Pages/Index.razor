@page "/"
@using AuthSample.Frontend.Models
@using AuthSample.Frontend.Services
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Профиль</PageTitle>


<div class="profile-container">
    @if (_isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
        </div>
    }
    else if (_user != null)
    {
        <div class="profile-card">
            <h3>Профиль пользователя</h3>

            <div class="profile-info">
                <div class="info-row">
                    <span class="label">Логин:</span>
                    <span class="value">@_user.Login</span>
                </div>

                <div class="info-row">
                    <span class="label">Подписки:</span>
                    <span class="value clickable" @onclick="ShowFollowersModal">@_user.SubscriptionsCount</span>
                </div>

                <div class="info-row">
                    <span class="label">Подписчики:</span>
                    <span class="value clickable" @onclick="ShowFollowingModal">@_user.SubscribersCount</span>
                </div>

                <div class="info-row">
                    <span class="label">Дата регистрации:</span>
                    <span class="value">@_user.RegistrationDate.ToString("dd.MM.yyyy HH:mm")</span>
                </div>
            </div>

            <button @onclick="HandleLogout" class="btn btn-danger w-100 mt-4">
                Выйти
            </button>
        </div>
    }
    else
    {
        <div class="alert alert-danger">
            Не удалось загрузить профиль
        </div>
    }
</div>

@if (!_isLoading && _user != null)
{
    <div class="users-section">
        <h3>Все пользователи</h3>

        @if (_users.Count == 0)
        {
            <p class="text-muted">Пользователи не найдены</p>
        }
        else
        {
            <div class="users-list">
                @foreach (var user in _users.Where(u => u.Id != _user.Id))
                {
                    <div class="user-card">
                        <div class="user-info">
                            <span class="user-login">@user.Login</span>
                            <span class="user-stats">
                                Подписчики: @user.SubscribersCount | Подписки: @user.SubscriptionsCount
                            </span>
                        </div>
                        <div class="user-actions">
                            @if (_followingIds.Contains(user.Id))
                            {
                                <button class="btn btn-outline-danger btn-sm"
                                        @onclick="() => HandleUnfollow(user.Id)"
                                        disabled="@_actionInProgress">
                                    Отписаться
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-primary btn-sm"
                                        @onclick="() => HandleFollow(user.Id)"
                                        disabled="@_actionInProgress">
                                    Подписаться
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
}

@if (_showModal)
{
    <div class="modal-backdrop" @onclick="CloseModal"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@_modalTitle</h5>
                <button type="button" class="btn-close" @onclick="CloseModal"></button>
            </div>
            <div class="modal-body">
                @if (_modalLoading)
                {
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                    </div>
                }
                else if (_modalUsers.Count == 0)
                {
                    <p class="text-muted text-center mb-0">Список пуст</p>
                }
                else
                {
                    <ul class="modal-user-list">
                        @foreach (var login in _modalUsers)
                        {
                            <li>@login</li>
                        }
                    </ul>
                }
            </div>
        </div>
    </div>
}

<style>
    .profile-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 80vh;
    }

    .profile-card {
        width: 100%;
        max-width: 500px;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        background: white;
    }

    .profile-info {
        margin-top: 1.5rem;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e9ecef;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .label {
        font-weight: 600;
        color: #495057;
    }

    .value {
        color: #212529;
    }

    .users-section {
        max-width: 600px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .users-section h3 {
        margin-bottom: 1rem;
        text-align: center;
    }

    .users-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .user-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .user-info {
        display: flex;
        flex-direction: column;
    }

    .user-login {
        font-weight: 600;
        color: #212529;
    }

    .user-stats {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .user-actions {
        flex-shrink: 0;
    }

    .clickable {
        cursor: pointer;
        color: #0d6efd;
        text-decoration: underline;
    }

    .clickable:hover {
        color: #0a58ca;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
    }

    .modal-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1050;
        width: 100%;
        max-width: 400px;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .modal-title {
        margin: 0;
        font-size: 1.1rem;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6c757d;
        line-height: 1;
    }

    .btn-close:hover {
        color: #212529;
    }

    .modal-body {
        padding: 1rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .modal-user-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .modal-user-list li {
        padding: 0.5rem 0;
        border-bottom: 1px solid #e9ecef;
    }

    .modal-user-list li:last-child {
        border-bottom: none;
    }
</style>

@code {
    private UserInfoResponse? _user;
    private List<UserInfoResponse> _users = new();
    private HashSet<Guid> _followingIds = new();
    private bool _isLoading = true;
    private bool _actionInProgress;

    private bool _showModal;
    private bool _modalLoading;
    private string _modalTitle = "";
    private List<string> _modalUsers = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        _isLoading = true;
        _user = await AuthService.GetCurrentUserAsync();
        if (_user == null)
        {
            Navigation.NavigateTo("/login", forceLoad: true);
            return;
        }

        _users = await AuthService.GetAllUsersAsync();
        await LoadFollowingIds();

        _isLoading = false;
        StateHasChanged();
    }

    private async Task LoadFollowingIds()
    {
        _followingIds.Clear();

        if (_user == null) return;

        var followingLogins = await AuthService.GetFollowingAsync(_user.Id);
        foreach (var user in _users.Where(u => followingLogins.Contains(u.Login)))
        {
            _followingIds.Add(user.Id);
        }
    }

    private async Task HandleFollow(Guid userId)
    {
        _actionInProgress = true;
        StateHasChanged();

        var success = await AuthService.FollowUserAsync(userId);
        if (success)
        {
            _followingIds.Add(userId);
            _user = await AuthService.GetCurrentUserAsync();
            _users = await AuthService.GetAllUsersAsync();
        }

        _actionInProgress = false;
        StateHasChanged();
    }

    private async Task HandleUnfollow(Guid userId)
    {
        _actionInProgress = true;
        StateHasChanged();

        var success = await AuthService.UnfollowUserAsync(userId);
        if (success)
        {
            _followingIds.Remove(userId);
            _user = await AuthService.GetCurrentUserAsync();
            _users = await AuthService.GetAllUsersAsync();
        }

        _actionInProgress = false;
        StateHasChanged();
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login", forceLoad: true);
    }

    private async Task ShowFollowersModal()
    {
        if (_user == null) return;

        _modalTitle = "Подписчики";
        _showModal = true;
        _modalLoading = true;
        _modalUsers.Clear();
        StateHasChanged();

        _modalUsers = await AuthService.GetFollowersAsync(_user.Id);
        _modalLoading = false;
        StateHasChanged();
    }

    private async Task ShowFollowingModal()
    {
        if (_user == null) return;

        _modalTitle = "Подписки";
        _showModal = true;
        _modalLoading = true;
        _modalUsers.Clear();
        StateHasChanged();

        _modalUsers = await AuthService.GetFollowingAsync(_user.Id);
        _modalLoading = false;
        StateHasChanged();
    }

    private void CloseModal()
    {
        _showModal = false;
        _modalUsers.Clear();
    }
}